<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¨æŠ¼æŒ–çŸ¿ DApp</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-top: 20px;
        }
        .wallet-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .info-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }
        .input-group {
            margin: 20px 0;
        }
        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="wallet-section">
            <h1>ğŸ’° è´¨æŠ¼æŒ–çŸ¿ DApp</h1>
            <button id="connectWallet">è¿æ¥é’±åŒ…</button>
        </div>
        
        <div id="walletInfo" style="display:none;">
            <div class="info-card">
                <p>ğŸ‘› é’±åŒ…åœ°å€: <span id="walletAddress"></span></p>
                <p>ğŸª™ ä»£å¸ä½™é¢: <span id="tokenBalance">0</span> ENG</p>
                <p>ğŸ’ è´¨æŠ¼ä½™é¢: <span id="stakedBalance">0</span> ENG</p>
                <p>ğŸ å¾…é¢†å–å¥–åŠ±: <span id="pendingRewards">0</span> ENG</p>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-item">
                <h3>æ€»è´¨æŠ¼é‡</h3>
                <p id="totalStaked">0</p>
            </div>
            <div class="stat-item">
                <h3>å¹´åŒ–æ”¶ç›Šç‡</h3>
                <p id="apr">â‰ˆ 15%</p>
            </div>
            <div class="stat-item">
                <h3>å¥–åŠ±ç‡</h3>
                <p id="rewardRate">0.01/ç§’</p>
            </div>
            <div class="stat-item">
                <h3>åˆçº¦ä½™é¢</h3>
                <p id="contractBalance">0</p>
            </div>
        </div>
        
        <div class="info-card">
            <h2>è´¨æŠ¼æ“ä½œ</h2>
            <div class="input-group">
                <input type="number" id="stakeAmount" placeholder="è¾“å…¥è´¨æŠ¼æ•°é‡ (ENG)" min="0" step="0.1">
                <button id="stakeBtn" onclick="stakeTokens()">è´¨æŠ¼</button>
            </div>
            
            <h2>é¢†å–æ“ä½œ</h2>
            <div class="input-group">
                <button id="claimBtn" onclick="claimRewards()">é¢†å–å¥–åŠ±</button>
                <button id="exitBtn" onclick="exitStaking()">å…¨éƒ¨æå–</button>
            </div>
            
            <h2>å–å›è´¨æŠ¼</h2>
            <div class="input-group">
                <input type="number" id="withdrawAmount" placeholder="è¾“å…¥å–å›æ•°é‡ (ENG)" min="0" step="0.1">
                <button id="withdrawBtn" onclick="withdrawTokens()">å–å›</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <p>â³ äº¤æ˜“å¤„ç†ä¸­ï¼Œè¯·ç­‰å¾…...</p>
        </div>
        
        <div id="transactionStatus" style="display:none; margin-top:20px; padding:15px; background:rgba(0,255,0,0.2); border-radius:8px;">
            <p>âœ… äº¤æ˜“æˆåŠŸï¼</p>
            <p id="txHash"></p>
        </div>
    </div>
    
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    <script>
        // åˆçº¦åœ°å€é…ç½®
        const ENHANCED_TOKEN_ADDRESS = "0xC4769961d5ed107fd6be28Fb140D42245444e4AE";
        const STAKING_CONTRACT_ADDRESS = ""; // éƒ¨ç½²åå¡«å…¥
        
        // åˆçº¦ABIï¼ˆç®€åŒ–ç‰ˆï¼‰
        const tokenABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function decimals() view returns (uint8)"
        ];
        
        const stakingABI = [
            "function stake(uint256 amount)",
            "function withdraw(uint256 amount)",
            "function getReward()",
            "function exit()",
            "function balanceOf(address) view returns (uint256)",
            "function earned(address) view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function rewardRate() view returns (uint256)"
        ];
        
        let provider, signer, tokenContract, stakingContract;
        let userAddress;
        
        // è¿æ¥é’±åŒ…
        document.getElementById('connectWallet').onclick = connectWallet;
        
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // è¯·æ±‚è´¦æˆ·è¿æ¥
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    // åˆå§‹åŒ–åˆçº¦
                    tokenContract = new ethers.Contract(ENHANCED_TOKEN_ADDRESS, tokenABI, signer);
                    
                    // æ›´æ–°UI
                    document.getElementById('walletAddress').textContent = 
                        userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                    document.getElementById('walletInfo').style.display = 'block';
                    document.getElementById('connectWallet').textContent = 'å·²è¿æ¥';
                    document.getElementById('connectWallet').disabled = true;
                    
                    // åŠ è½½æ•°æ®
                    await loadData();
                    
                } catch (error) {
                    console.error("è¿æ¥é’±åŒ…å¤±è´¥:", error);
                    alert("è¿æ¥é’±åŒ…å¤±è´¥: " + error.message);
                }
            } else {
                alert("è¯·å®‰è£…MetaMask!");
            }
        }
        
        async function loadData() {
            if (!tokenContract) return;
            
            try {
                // åŠ è½½ç”¨æˆ·ä»£å¸ä½™é¢
                const tokenBalance = await tokenContract.balanceOf(userAddress);
                document.getElementById('tokenBalance').textContent = 
                    ethers.formatEther(tokenBalance);
                
                // åŠ è½½åˆçº¦æ•°æ®ï¼ˆå¦‚æœæœ‰è´¨æŠ¼åˆçº¦åœ°å€ï¼‰
                if (STAKING_CONTRACT_ADDRESS) {
                    stakingContract = new ethers.Contract(STAKING_CONTRACT_ADDRESS, stakingABI, signer);
                    
                    const stakedBalance = await stakingContract.balanceOf(userAddress);
                    const pendingRewards = await stakingContract.earned(userAddress);
                    const totalStaked = await stakingContract.totalSupply();
                    const rewardRate = await stakingContract.rewardRate();
                    
                    document.getElementById('stakedBalance').textContent = 
                        ethers.formatEther(stakedBalance);
                    document.getElementById('pendingRewards').textContent = 
                        ethers.formatEther(pendingRewards);
                    document.getElementById('totalStaked').textContent = 
                        ethers.formatEther(totalStaked);
                    document.getElementById('rewardRate').textContent = 
                        ethers.formatEther(rewardRate) + '/ç§’';
                    
                    // è®¡ç®—APRï¼ˆè¿‘ä¼¼å€¼ï¼‰
                    const apr = (Number(ethers.formatEther(rewardRate)) * 86400 * 365 / 
                                (Number(ethers.formatEther(totalStaked)) || 1)) * 100;
                    document.getElementById('apr').textContent = apr.toFixed(2) + '%';
                }
                
            } catch (error) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
            }
        }
        
        async function stakeTokens() {
            const amount = document.getElementById('stakeAmount').value;
            if (!amount || amount <= 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è´¨æŠ¼æ•°é‡");
                return;
            }
            
            if (!STAKING_CONTRACT_ADDRESS) {
                alert("è¯·å…ˆéƒ¨ç½²è´¨æŠ¼åˆçº¦å¹¶é…ç½®åœ°å€");
                return;
            }
            
            try {
                showLoading(true);
                
                // æˆæƒè´¨æŠ¼åˆçº¦ä½¿ç”¨ä»£å¸
                const amountWei = ethers.parseEther(amount);
                
                // æ£€æŸ¥æˆæƒé¢åº¦
                const allowance = await tokenContract.allowance(userAddress, STAKING_CONTRACT_ADDRESS);
                
                if (allowance < amountWei) {
                    // éœ€è¦æˆæƒ
                    const approveTx = await tokenContract.approve(STAKING_CONTRACT_ADDRESS, amountWei);
                    await approveTx.wait();
                }
                
                // æ‰§è¡Œè´¨æŠ¼
                const stakeTx = await stakingContract.stake(amountWei);
                await stakeTx.wait();
                
                showSuccess("è´¨æŠ¼æˆåŠŸï¼", stakeTx.hash);
                await loadData(); // åˆ·æ–°æ•°æ®
                
            } catch (error) {
                console.error("è´¨æŠ¼å¤±è´¥:", error);
                alert("è´¨æŠ¼å¤±è´¥: " + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function claimRewards() {
            try {
                showLoading(true);
                
                const claimTx = await stakingContract.getReward();
                await claimTx.wait();
                
                showSuccess("é¢†å–æˆåŠŸï¼", claimTx.hash);
                await loadData(); // åˆ·æ–°æ•°æ®
                
            } catch (error) {
                console.error("é¢†å–å¤±è´¥:", error);
                alert("é¢†å–å¤±è´¥: " + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function exitStaking() {
            try {
                showLoading(true);
                
                const exitTx = await stakingContract.exit();
                await exitTx.wait();
                
                showSuccess("å…¨éƒ¨æå–æˆåŠŸï¼", exitTx.hash);
                await loadData(); // åˆ·æ–°æ•°æ®
                
            } catch (error) {
                console.error("æå–å¤±è´¥:", error);
                alert("æå–å¤±è´¥: " + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function withdrawTokens() {
            const amount = document.getElementById('withdrawAmount').value;
            if (!amount || amount <= 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å–å›æ•°é‡");
                return;
            }
            
            try {
                showLoading(true);
                
                const amountWei = ethers.parseEther(amount);
                const withdrawTx = await stakingContract.withdraw(amountWei);
                await withdrawTx.wait();
                
                showSuccess("å–å›æˆåŠŸï¼", withdrawTx.hash);
                await loadData(); // åˆ·æ–°æ•°æ®
                
            } catch (error) {
                console.error("å–å›å¤±è´¥:", error);
                alert("å–å›å¤±è´¥: " + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showSuccess(message, txHash) {
            document.getElementById('transactionStatus').style.display = 'block';
            document.getElementById('txHash').textContent = 
                `äº¤æ˜“å“ˆå¸Œ: ${txHash.substring(0, 20)}...`;
            
            // 5ç§’åéšè—æˆåŠŸæ¶ˆæ¯
            setTimeout(() => {
                document.getElementById('transactionStatus').style.display = 'none';
            }, 5000);
        }
        
        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    loadData();
                } else {
                    // ç”¨æˆ·æ–­å¼€è¿æ¥
                    location.reload();
                }
            });
        }
    </script>
</body>
</html>